version: 1.4.{build}
branches:
  only:
  - master
  - 1.4
image: Visual Studio 2022

environment:
  matrix:
  - PLATFORM: x64
    CONFIGURATION: Release
  APPVEYOR_RDP_PASSWORD: nixioBuild@av

init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

install:
- cmd: >-
    choco install nsis.install -version 2.49 -y --ignore-checksums

    if not exist C:\deps.zip appveyor DownloadFile https://projects.g-node.org/nix/nix-dependencies-windows-20160121.zip -FileName C:\deps.zip

    if not exist C:\deps 7z x -y C:\deps.zip -oC:\deps > NUL:
build_script:
- cmd: >-
    c:\deps\nixenv.bat

    ctest -VV --output-on-failure -S .appveyor.ctest

on_finish:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  
after_build:
- cmd: cmake --build .\build --config %CONFIGURATION% --target PACKAGE

artifacts:
- path: build\*.exe
